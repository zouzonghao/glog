{{ define "title" }}{{ if .post }}编辑文章{{ else }}写新文章{{ end }}{{ end }}

{{ define "content" }}
    <h2 class="group-title">{{ if .post }}文章编辑{{ else }}文章新建{{ end }}</h2>
    <div class="editor-container">
        <form id="app-form" action="/admin/save" method="POST" class="app-form">
            <input type="hidden" id="post-id" name="id" value="{{ if .post }}{{ .post.ID }}{{ else }}0{{ end }}">
            
            <div class="editor-form-group editor-title-group">
                <input type="text" id="title" name="title" value="{{ if .post }}{{ .post.Title }}{{ else }}未命名标题{{ end }}" required>
                <input type="text" id="published_at" name="published_at" value="{{ if .post }}{{ .post.PublishedAt.Format "2006-01-02 15:04" }}{{ else }}{{ .now }}{{ end }}">
            </div>
            
            <div class="editor-form-group">
                <textarea id="content" name="content" rows="20">{{ if .post }}{{ .post.Content }}{{ else }}
<!--more-->
{{ end }}</textarea>
            </div>
            
            <div class="editor-options">
                <div class="form-group-inline">
                    <input type="checkbox" id="ai_summary" name="ai_summary">
                    <label for="ai_summary">AI摘要</label>
                </div>
                <div class="form-group-inline">
                    <input type="checkbox" id="is_private" name="is_private" {{ if .post }}{{ if .post.IsPrivate }}checked{{ end }}{{ end }}>
                    <label for="is_private">私密</label>
                </div>
            </div>

            <div class="editor-actions">
                <a href="#" id="save-btn">💾 保存文章</a>
                <a href="{{ if .post }}/post/{{ .post.Slug }}{{ else }}#{{ end }}" class="open-post-link">🔗 打开文章</a>
            </div>
        </form>
    </div>
{{ end }}

{{ define "scripts" }}
    <script>
        // AJAX form submission
        document.getElementById('save-btn').addEventListener('click', function(event) {
            event.preventDefault();

            // Validate the published_at time format
            const publishedAtInput = document.getElementById('published_at');
            const publishedAtValue = publishedAtInput.value;
            const dateTimeRegex = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/;

            if (!dateTimeRegex.test(publishedAtValue)) {
                showNotification('发布时间格式不正确，应为 YYYY-MM-DD HH:mm', 'error');
                return; // Stop the submission
            }

            const form = document.getElementById('app-form');
            const formData = new FormData(form);
            const postIdInput = document.getElementById('post-id');

            fetch(form.action, {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                let alertClass = 'info';
                if (data.status === 'success') {
                    alertClass = 'success';
                    // Update post ID for new posts
                    if (postIdInput.value === '0' && data.post_id) {
                        postIdInput.value = data.post_id;
                        // Update browser URL to reflect the new post ID for editing
                        const newUrl = `/admin/editor?id=${data.post_id}`;
                        history.pushState({path: newUrl}, '', newUrl);
                    }

                    // Dynamically update "Open Post" link
                    const openLink = document.querySelector('.editor-actions a.open-post-link');
                    if (data.slug) {
                        openLink.href = `/post/${data.slug}`;
                    } else {
                        openLink.href = '#';
                    }
                } else if (data.status === 'error' || data.status === 'locked') {
                    alertClass = 'error';
                }
                
                showNotification(data.message, alertClass);
            })
            .catch(error => {
                console.error('保存错误：', error);
                showNotification('保存时发生错误，请检查网络！', 'error');
            });
        });

        // Handle click on "Open Post" link
        document.querySelector('.open-post-link').addEventListener('click', function(event) {
            const postId = document.getElementById('post-id').value;
            if (postId === '0') {
                event.preventDefault();
                showNotification('文章尚未保存，无法打开！', 'info');
            }
        });
    </script>
{{ end }}