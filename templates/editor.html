{{ define "title" }}{{ if .post }}ç¼–è¾‘æ–‡ç« {{ else }}å†™æ–°æ–‡ç« {{ end }}{{ end }}

{{ define "head" }}
    {{/* By default, we don't load the editor CSS anymore */}}
{{ end }}

{{ define "content" }}
    <h2 class="group-title">{{ if .post }}æ–‡ç« ç¼–è¾‘{{ else }}æ–‡ç« æ–°å»º{{ end }}</h2>
    <div class="editor-container">
        <div id="editor-alert-container"></div>
        {{ if .status }}
            {{ if eq .status "locked" }}
                <div class="alert info">æ­£åœ¨ç”ŸæˆAIæ‘˜è¦ï¼Œæ–‡ç« å·²é”å®šï¼Œè¯·ç¨å€™å†è¯•ã€‚</div>
            {{ else if eq .status "saved" }}
                <div class="alert success">æ–‡ç« å·²ä¿å­˜ã€‚</div>
            {{ end }}
        {{ end }}

        <form id="editor-form" action="/admin/save" method="POST" class="editor-form">
            <input type="hidden" id="post-id" name="id" value="{{ if .post }}{{ .post.ID }}{{ else }}0{{ end }}">
            
            <div class="form-group">
                <!-- <label for="title">æ ‡é¢˜</label> -->
                <input type="text" id="title" name="title" value="{{ if .post }}{{ .post.Title }}{{ else }}æœªå‘½åæ ‡é¢˜{{ end }}" required>
            </div>
            
            <div class="form-group">
                <!-- <label for="content">å†…å®¹</label> -->
                <textarea id="content" name="content" rows="20">{{ if .post }}{{ .post.Content }}{{ else }}
<!--more-->{{ end }}</textarea>
            </div>
            
            <div class="editor-options">
                <div class="form-group-inline">
                    <input type="checkbox" id="load-editor">
                    <label for="load-editor">åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</label>
                </div>
                <div class="form-group-inline">
                    <input type="checkbox" id="ai_summary" name="ai_summary">
                    <label for="ai_summary">AIæ‘˜è¦</label>
                </div>
                <div class="form-group-inline">
                    <input type="checkbox" id="published" name="published" {{ if or (not .post) .post.Published }}checked{{ end }}>
                    <label for="published">å‘å¸ƒ</label>
                </div>
                <div class="form-group-inline">
                    <input type="checkbox" id="is_private" name="is_private" {{ if .post }}{{ if .post.IsPrivate }}checked{{ end }}{{ end }}>
                    <label for="is_private">ç§å¯†</label>
                </div>
            </div>

            <div class="editor-actions">
                <a href="#" id="save-btn">ğŸ’¾ ä¿å­˜æ–‡ç« </a>
                {{ if .post }}
                    {{ if .post.Published }}
                        <a href="/post/{{ .post.Slug }}"  class="open-post-link">ğŸ”— æ‰“å¼€æ–‡ç« </a>
                    {{ end }}
                {{ end }}
            </div>
        </form>
    </div>
{{ end }}

{{ define "scripts" }}
    <script>
        // Rich text editor loader
        document.getElementById('load-editor').addEventListener('change', function() {
            if (this.checked) {
                this.disabled = true;
                this.parentElement.querySelector('label').textContent = 'æ­£åœ¨åŠ è½½ç¼–è¾‘å™¨...';
                var cssLink = document.createElement('link');
                cssLink.rel = 'stylesheet';
                cssLink.href = '/static/css/simplemde.min.css';
                document.head.appendChild(cssLink);
                var script = document.createElement('script');
                script.src = '/static/js/simplemde.min.js';
                document.body.appendChild(script);
                script.onload = function() {
                    new SimpleMDE({
                        element: document.getElementById("content"),
                        spellChecker: false
                    });
                    document.getElementById('load-editor').parentElement.querySelector('label').textContent = 'ç¼–è¾‘å™¨åŠ è½½å®Œæ¯•';
                };
            }
        });

        // AJAX form submission
        document.getElementById('save-btn').addEventListener('click', function(event) {
            event.preventDefault();
            const form = document.getElementById('editor-form');
            const formData = new FormData(form);
            const alertContainer = document.getElementById('editor-alert-container');
            const postIdInput = document.getElementById('post-id');

            fetch(form.action, {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                let alertClass = 'info';
                if (data.status === 'success') {
                    alertClass = 'success';
                    // Update post ID for new posts
                    if (postIdInput.value === '0' && data.post_id) {
                        postIdInput.value = data.post_id;
                        // Update browser URL to reflect the new post ID for editing
                        const newUrl = `/admin/editor?id=${data.post_id}`;
                        history.pushState({path: newUrl}, '', newUrl);
                    }

                    // Dynamically update "Open Post" link
                    const isPublished = document.getElementById('published').checked;
                    const editorActions = document.querySelector('.editor-actions');
                    let openLink = editorActions.querySelector('a.open-post-link');

                    if (isPublished && data.slug) {
                        if (!openLink) {
                            openLink = document.createElement('a');
                            openLink.className = 'open-post-link';
                            openLink.target = '_blank';
                            editorActions.appendChild(openLink);
                        }
                        openLink.href = `/post/${data.slug}`;
                        openLink.textContent = 'æ‰“å¼€æ–‡ç« ';
                    } else {
                        if (openLink) {
                            openLink.remove();
                        }
                    }
                } else if (data.status === 'error' || data.status === 'locked') {
                    alertClass = 'error';
                }
                
                alertContainer.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;
                setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
            })
            .catch(error => {
                console.error('ä¿å­˜é”™è¯¯ï¼š', error);
                alertContainer.innerHTML = `<div class="alert error">ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</div>`;
            });
        });
    </script>
{{ end }}