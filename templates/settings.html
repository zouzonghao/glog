{{define "title"}}ç«™ç‚¹è®¾ç½®{{end}}

{{define "content"}}
<div class="setting-header">
    <h2 class="group-title">ç«™ç‚¹è®¾ç½®</h2>
</div>

<div id="alert-container"></div>

<form id="settings-form" action="/settings" method="POST" class="editor-form">
    <div class="form-group">
        <label for="password">ç®¡ç†å‘˜å¯†ç </label>
        <input type="password" id="password" name="password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹" autocomplete="new-password">
    </div>

    <div class="form-group">
        <label for="site_logo">ç«™ç‚¹ Logo URL</label>
        <input type="text" id="site_logo" name="site_logo" value="{{ .site_logo }}">
    </div>

    <div class="form-group">
        <label for="site_title">ç«™ç‚¹æ ‡é¢˜</label>
        <input type="text" id="site_title" name="site_title" value="{{ .site_title }}">
    </div>

    <div class="form-group">
        <label for="site_description">ç«™ç‚¹æè¿°</label>
        <input type="text" id="site_description" name="site_description" value="{{ .site_description }}">
    </div>

    <div class="form-group">
        <label for="search_engine">æœç´¢å¼•æ“</label>
        <select id="search_engine" name="search_engine">
            <option value="like" {{if eq .search_engine "like"}}selected{{end}}>Like</option>
            <option value="fts5" {{if eq .search_engine "fts5"}}selected{{end}}>FTS5</option>
        </select>
    </div>

    <div class="setting-header">
        <h2 class="group-title">AI è®¾ç½®</h2>
    </div>
    <div id="ai-test-alert-container"></div>

    <div class="form-group">
        <label for="openai_base_url">OpenAI å…¼å®¹ Base URL</label>
        <input type="text" id="openai_base_url" name="openai_base_url" value="{{ .openai_base_url }}">
    </div>

    <div class="form-group">
        <label for="openai_token">å¯†é’¥</label>
        <input type="password" id="openai_token" name="openai_token" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹" autocomplete="new-password">
    </div>

    <div class="form-group">
        <label for="openai_model">æ¨¡å‹</label>
        <input type="text" id="openai_model" name="openai_model" value="{{ .openai_model }}">
    </div>

    <div class="form-group">
        <a href="#" id="test-ai-btn">ğŸš€ æµ‹è¯•è¿æ¥</a>
    </div>

    <hr>

    <div class="editor-actions">
        <a href="#" id="save-settings-btn">ğŸ’¾ ä¿å­˜è®¾ç½®</a>
    </div>
</form>
{{end}}

{{define "scripts"}}
<script>
// AJAX for saving settings
document.getElementById('save-settings-btn').addEventListener('click', function(event) {
    event.preventDefault();

    const form = document.getElementById('settings-form');
    const formData = new FormData(form);
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = ''; // Clear previous messages

    fetch(form.action, {
        method: 'POST',
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        let alertClass = data.status === 'success' ? 'success' : 'error';
        alertContainer.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;

        if (data.status === 'success') {
            document.getElementById('password').value = '';
            document.getElementById('openai_token').value = '';
        }
        
        setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
    })
    .catch(error => {
        console.error('è¡¨å•æäº¤é”™è¯¯ï¼š', error);
        alertContainer.innerHTML = `<div class="alert error">ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</div>`;
    });
});

// AJAX for testing AI connection
document.getElementById('test-ai-btn').addEventListener('click', function(event) {
    event.preventDefault();
    const baseURL = document.getElementById('openai_base_url').value;
    const token = document.getElementById('openai_token').value;
    const model = document.getElementById('openai_model').value;
    const alertContainer = document.getElementById('ai-test-alert-container');
    const testBtn = this;

    alertContainer.innerHTML = `<div class="alert info">æµ‹è¯•ä¸­...</div>`;
    testBtn.style.pointerEvents = 'none'; // Disable link
    testBtn.style.opacity = '0.5';

    const formData = new URLSearchParams();
    formData.append('openai_base_url', baseURL);
    formData.append('openai_token', token);
    formData.append('openai_model', model);

    fetch('/settings/test-ai', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        let alertClass = data.status === 'success' ? 'success' : 'error';
        alertContainer.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;
    })
    .catch(error => {
        console.error('AI æµ‹è¯•é”™è¯¯ï¼š', error);
        alertContainer.innerHTML = `<div class="alert error">æµ‹è¯•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åå°æ—¥å¿—ã€‚</div>`;
    })
    .finally(() => {
        testBtn.style.pointerEvents = 'auto'; // Re-enable link
        testBtn.style.opacity = '1';
        setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
    });
});
</script>
{{end}}