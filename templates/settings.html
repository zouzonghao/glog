{{define "title"}}站点设置{{end}}

{{define "content"}}
<div class="admin-header">
    <h2>站点设置</h2>
</div>

<div id="alert-container"></div>

<form id="settings-form" action="/admin/settings" method="POST" class="editor-form">
    <div class="form-group">
        <label for="password">管理员密码</label>
        <input type="password" id="password" name="password" placeholder="留空则不修改" autocomplete="new-password">
    </div>

    <div class="form-group">
        <label for="site_logo">站点 Logo URL</label>
        <input type="text" id="site_logo" name="site_logo" value="{{ .site_logo }}">
    </div>

    <div class="form-group">
        <label for="site_description">站点描述 (Meta Description)</label>
        <input type="text" id="site_description" name="site_description" value="{{ .site_description }}">
    </div>

    <hr>
    <h3>AI 摘要设置</h3>
    <div id="ai-test-alert-container"></div>

    <div class="form-group">
        <label for="openai_base_url">OpenAI Compatible Base URL</label>
        <input type="text" id="openai_base_url" name="openai_base_url" value="{{ .openai_base_url }}">
    </div>

    <div class="form-group">
        <label for="openai_token">Token</label>
        <input type="password" id="openai_token" name="openai_token" placeholder="留空则不修改" autocomplete="new-password">
    </div>

    <div class="form-group">
        <label for="openai_model">Model</label>
        <input type="text" id="openai_model" name="openai_model" value="{{ .openai_model }}">
    </div>

    <div class="form-group">
        <button type="button" id="test-ai-btn" class="btn btn-secondary">测试连接</button>
    </div>

    <hr>

    <button type="submit" class="btn">保存设置</button>
</form>
{{end}}

{{define "scripts"}}
<script>
// AJAX for saving settings
document.getElementById('settings-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = ''; // Clear previous messages

    fetch(form.action, {
        method: 'POST',
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        let alertClass = data.status === 'success' ? 'success' : 'error';
        alertContainer.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;

        if (data.status === 'success') {
            document.getElementById('password').value = '';
            document.getElementById('openai_token').value = '';
        }
        
        setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
    })
    .catch(error => {
        console.error('Form submission error:', error);
        alertContainer.innerHTML = `<div class="alert error">保存时发生错误，请检查网络连接。</div>`;
    });
});

// AJAX for testing AI connection
document.getElementById('test-ai-btn').addEventListener('click', function() {
    const baseURL = document.getElementById('openai_base_url').value;
    const token = document.getElementById('openai_token').value;
    const model = document.getElementById('openai_model').value;
    const alertContainer = document.getElementById('ai-test-alert-container');
    const testBtn = this;

    alertContainer.innerHTML = `<div class="alert info">测试中...</div>`;
    testBtn.disabled = true;

    const formData = new URLSearchParams();
    formData.append('openai_base_url', baseURL);
    formData.append('openai_token', token);
    formData.append('openai_model', model);

    fetch('/admin/settings/test-ai', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        let alertClass = data.status === 'success' ? 'success' : 'error';
        alertContainer.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;
    })
    .catch(error => {
        console.error('AI test error:', error);
        alertContainer.innerHTML = `<div class="alert error">测试请求失败，请检查网络或后台日志。</div>`;
    })
    .finally(() => {
        testBtn.disabled = false;
        setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
    });
});
</script>
{{end}}