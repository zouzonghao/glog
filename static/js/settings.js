function handleJsonFile(t){let e=new FileReader;e.onload=function(t){try{let e=JSON.parse(t.target.result);validateBackupJson(e)?uploadJsonData(e):showNotification("JSON 文件结构不正确。必须包含 posts 数组。","error")}catch(n){showNotification("解析 JSON 文件失败: "+n.message,"error")}finally{document.getElementById("backup-file").value=""}},e.onerror=function(){showNotification("读取文件失败！","error"),document.getElementById("backup-file").value=""},e.readAsText(t)}function validateBackupJson(t){if("object"!=typeof t||null===t||!t.hasOwnProperty("posts")||!Array.isArray(t.posts)||t.hasOwnProperty("settings")&&("object"!=typeof t.settings||null===t.settings))return!1;if(t.posts.length>0){let e=t.posts[0];if(void 0===e.title||void 0===e.content||void 0===e.is_private||void 0===e.published_at)return!1}return!0}function uploadJsonData(t){showNotification("正在上传并恢复...","info"),fetch("/admin/setting/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(t=>t.json()).then(t=>{showNotification(t.message,t.status)}).catch(t=>{console.error("上传错误:",t),showNotification("上传失败，请检查网络或后台日志！","error")})}function uploadZipFile(t,e=""){let n=new FormData;n.append("backup",t),e&&n.append("password",e),showNotification("正在上传并恢复...","info"),fetch("/admin/setting/upload",{method:"POST",body:n}).then(t=>t.json()).then(t=>{showNotification(t.message,t.status),document.getElementById("backup-file").value=""}).catch(t=>{console.error("上传错误:",t),showNotification("上传失败，请检查网络或后台日志！","error"),document.getElementById("backup-file").value=""})}function attachModalFormLogic(t,e,n){let a=document.getElementById(t),o=document.getElementById(e),i=document.getElementById(n);a&&o&&i&&a.addEventListener("click",t=>{t.preventDefault(),saveFormData(o,()=>{i.classList.remove("show")})})}function attachTestConnectionLogic(t,e,n){let a=document.getElementById(t),o=document.getElementById(e);a&&o&&a.addEventListener("click",t=>{t.preventDefault();let e=t.target;showNotification("测试中...","info"),e.disabled=!0,fetch(n,{method:"POST",body:new URLSearchParams(new FormData(o))}).then(t=>t.json()).then(t=>showNotification(t.message,t.status)).catch(t=>{console.error("测试连接失败:",t),showNotification("测试请求失败，请检查网络或后台日志！","error")}).finally(()=>e.disabled=!1)})}function attachBackupNowLogic(t,e){let n=document.getElementById(t);n&&n.addEventListener("click",t=>{t.preventDefault();let n=t.target;showNotification("正在备份...","info"),n.disabled=!0,fetch(e,{method:"POST"}).then(t=>t.json()).then(t=>showNotification(t.message,t.status)).catch(t=>{console.error("立即备份失败:",t),showNotification("备份请求失败，请检查网络或后台日志！","error")}).finally(()=>n.disabled=!1)})}function saveFormData(t,e){let n=new FormData(t);fetch("/admin/setting",{method:"POST",body:new URLSearchParams(n)}).then(t=>t.json()).then(n=>{showNotification(n.message,n.status),"success"===n.status&&(t.querySelectorAll('input[type="password"]').forEach(t=>t.value=""),e&&e())}).catch(t=>{console.error("表单提交错误：",t),showNotification("保存时发生错误，请检查网络连接！","error")})}document.addEventListener("DOMContentLoaded",function(){let t=document.getElementById("settings-form");if(t){let e=document.getElementById("save-settings-btn");e.addEventListener("click",function(e){e.preventDefault(),saveFormData(t)})}setupGlobalModal("ai-modal","ai-settings-btn"),setupGlobalModal("github-modal","github-backup-btn"),setupGlobalModal("webdav-modal","webdav-backup-btn"),attachModalFormLogic("save-ai-btn","ai-settings-form","ai-modal"),attachModalFormLogic("save-github-btn","github-settings-form","github-modal"),attachModalFormLogic("save-webdav-btn","webdav-settings-form","webdav-modal"),attachTestConnectionLogic("test-ai-btn","ai-settings-form","/admin/setting/test-ai"),attachTestConnectionLogic("test-github-btn","github-settings-form","/admin/setting/test-github"),attachTestConnectionLogic("test-webdav-btn","webdav-settings-form","/admin/setting/test-webdav"),attachBackupNowLogic("backup-github-now-btn","/admin/setting/backup-github-now"),attachBackupNowLogic("backup-webdav-now-btn","/admin/setting/backup-webdav-now");let n=document.getElementById("upload-btn"),a=document.getElementById("backup-file");n&&a&&(n.addEventListener("click",function(t){t.preventDefault(),a.click()}),a.addEventListener("change",async function(t){let e=t.target.files[0];if(e){if(e.name.endsWith(".zip")){let n=await showGlobalPasswordPrompt("请输入备份文件密码：");if(null===n){t.target.value="";return}uploadZipFile(e,n)}else e.name.endsWith(".json")?handleJsonFile(e):(showNotification("请选择 .zip 或 .json 格式的备份文件。","error"),t.target.value="")}}))});